# 분산 시스템 환경에서의 세션 관리

## 기본 Spring Session object가 어디에 저장되나요?
- 기본적으로 Spring Session object는 `서버의 메모리`에 저장한다.

## 이것의 문제점은 무엇인가요?
- 세션 데이터를 서버의 메모리에 저장하게 되면 다음과 같은 문제가 발생한다. 
1) 세션 데이터 양이 많아지면, 서버의 메모리 부족으로 인해 성능이 저하될 수 있다.
2) 서버 장애 시 세션 데이터가 소실될 수 있다.
3) 여러 개의 서버의 경우, 서버 간의 세션 데이터의 일관성을 유지하기 어려워, 세션 불일치가 생겨난다.
   - 클라이언트가 처음 요청을 보낸 서버의 메모리에 해당 클라이언트의 세션 아이디를 저장한다.
   - 만약, 클라이언트가 다른 서버로 접근한다면, 해당 서버의 메모리엔 세셔 아이디가 없기에 아예 새로운 유저라고 생각하고 새로운 세션 아이디를 생성한다.
   - 그로 인해, 동일한 사용자인데, 여러개의 세션으로 관리되어 데이터 일관성이 깨질 수 있다.

## 해결책은 무엇인가요?
- 세션 정합성 문제를 해결하기 위해 3가지 옵션이 있다.
1) 세션 클러스터링(session clustering)
2) 스티키 세션(sticky session)
3) 레디스(reids)

### 1. 세션 클러스터링
<img width="750" alt="스크린샷 2023-05-08 오후 11 48 50" src="https://user-images.githubusercontent.com/60481383/236855991-b0452853-d54a-460c-a5bd-0702ac97f207.png">
- 여러 인스턴스로 묶인 동일한 클러스터 내에서, 여러 서버 간에 세션 데이터를 복사해서 공유하고 분산하는 방법이다.

#### 세션 클러스터링의 장점
1. 일관성: 클라이언트의 요청이 다른 서버로 전환되더라도 세션 데이터가 유지되어 일관성을 유지할 수 있습니다.
2. 고가용성: 서버 중 하나가 고장 나더라도 세션 데이터가 다른 서버에 복제되어 유지됩니다.
3. 확장성: 클러스터에 서버를 추가하여 세션 데이터의 용량과 처리량을 증가시킬 수 있습니다.

#### 세션 클러스터링의 단점
1. 복잡성: 클러스터 구성 및 관리에 대한 추가 작업이 필요할 수 있습니다.
2. 클러스터가 커질 수록 네트워크 트래픽 부하와 성능 저하가 일어나게 된다.
3. 세션 데이터 공유의 오버헤드: 여러 서버 간에 세션 데이터를 공유하기 위한 통신 오버헤드가 발생할 수 있습니다.

### 2. 스티키 세션 (sticky session)
<img width="750" alt="스크린샷 2023-05-08 오후 11 51 15" src="https://user-images.githubusercontent.com/60481383/236856663-625afa28-e28f-45ad-9b12-d1966ca34a36.png">

- 즉, 로드 밸런서(Load Balancer)가 클라이언트의 요청을 처리할 때, 동일한 클라이언트가 항상 동일한 서버로 요청을 보내도록 하는 방법이다.
- 이 방식은 로드 밸런서가 클라이언트와 서버 간의 연결을 추적하여 요청이 항상 동일한 서버로 전달되도록 보장합니다.
- 이를 위해 로드 밸런서는 클라이언트와 서버 사이의 연결을 추적하고, 추적 정보를 사용하여 항상 동일한 서버로 요청을 라우팅합니다.

#### 스티키 세션의 장점
1. 단순성: 세션 데이터를 공유하거나 클러스터를 구성할 필요가 없으므로, 구성 및 관리 작업이 간소화됩니다.
2. 일관성: 동일한 클라이언트가 항상 동일한 서버로 요청을 보내므로 세션 데이터의 일관성을 유지할 수 있습니다.

#### 스티키 세션의 단점
1. 부하 불균형 문제 발생 할 수 있음
- 스티키 세션은 클라이언트와 특정 서버 간의 연결을 유지하기 때문에 로드 밸런서가 요청을 공평하게 분산시키는 능력이 제한됩니다. 
- 만약, 일부 서버에 부하가 집중되면 다른 서버는 비교적 유휴 상태를 유지하게 됩니다. 
- 결과적으로 시스템의 전체 처리량이 제한될 수 있습니다.
2. 특정 서버 장애시, 해당 클라이언트의 요청을 받을 수 없게 된다. 
- 스티키 세션을 사용하는 경우, 연결을 유지하는 서버에 장애가 발생하면 해당 클라이언트의 요청은 서비스를 받을 수 없게 된다. 
- 따라서, 해당 서버의 장애 복구 시간 동안 해당 클라이언트는 서비스를 이용할 수 없는 상태가 될 수 있다.
- 이는 고가용성 및 장애 복구를 위한 전략을 구현하는 데 제약을 가할 수 있다.
3. 확장성 제한
- 스티키 세션은 서버의 확장성을 제한할 수 있습니다. 
- 새로운 서버를 추가하거나 기존 서버를 제거하는 경우에도 로드 밸런서는 클라이언트와 동일한 서버에 연결되도록 유지해야 합니다. 
- 이로 인해 서버의 수를 쉽게 조절하거나 유연하게 확장하는 것이 어려울 수 있습니다.

### 3. 별도의 세션 저장소 사용하기
<img width="750" alt="스크린샷 2023-05-09 오전 12 36 54" src="https://user-images.githubusercontent.com/60481383/236867030-4eead6b2-6c53-4015-9075-01261e77f57a.png">

- 세션 스토리지가 분리되면, 서버가 아무리 늘어난다고 할 지라도 세션 스토리지에 대한 정보만 각각의 서버에 입력해주면 세션을 공유할 수 있게 됩니다.
- 이러한 방식을 사용한다면 로드밸런싱 알고리즘만 잘 구현되어 있다는 가정 하에 Sticky Session처럼 트래픽이 비정상적으로 몰리는 현상을 고려하지 않아도 되게 됩니다.
- 

### 별도의 세션 저장소 사용하는 방법의 장점
1. 확장성
- 외부 세션 저장소는 분산 환경에서 확장성을 제공합니다. 
- 여러 서버가 동시에 세션 데이터를 읽고 쓸 수 있으며, 필요에 따라 서버를 추가하거나 제거하여 세션 처리 능력을 조정할 수 있습니다.
2. 고가용성 
- 외부 세션 저장소는 데이터를 안정적으로 보호하고 유실하지 않도록 합니다. 
- 데이터를 복제하거나 백업하여 장애 발생 시에도 세션 데이터를 보존할 수 있습니다.
3. 유연성
- 외부 세션 저장소를 사용하면 세션 데이터를 서버에서 분리할 수 있으므로, 다양한 서버 및 클라이언트 환경과 통합하기가 용이합니다. 
- 이는 다양한 플랫폼 및 언어에서 일관된 세션 관리를 제공할 수 있는 장점으로 작용할 수 있습니다.

### 별도의 세션 저장소 사용하는 방법의 단점
1. 추가 구성 및 관리
- 외부 세션 저장소를 사용하려면 해당 시스템을 구성하고 관리해야 합니다.
- 이는 일부 추가 작업 및 유지보수 비용이 발생할 수 있다는 것을 의미합니다.
2. 느린 응답 시간 
- 외부 세션 저장소를 사용하면 데이터베이스 호출이 필요하기 때문에 로드 및 저장 작업에 대한 응답 시간이 더 느릴 수 있습니다.
3. 의존성 및 단일 장애점
- 외부 세션 저장소는 외부 시스템에 의존하므로 해당 시스템의 가용성에 영향을 받을 수 있습니다. 
- 외부 저장소에 장애가 발생하면 세션 관리 및 애플리케이션 기능에 영향을 줄 수 있으며, 장애 복구에 대한 계획이 필요합니다.



# Reference
- https://daakludens.github.io/project/session/
- https://hyuntaeknote.tistory.com/4


